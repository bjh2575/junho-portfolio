name: Deploy Flask App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 리포지토리 체크아웃
      - uses: actions/checkout@v2

      # Python 설정
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.12

      # 의존성 설치
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # GitHub Secrets로부터 환경 변수 설정
      - name: Set environment variables
        run: |
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          echo "::add-mask::${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

      ## SSH 키 설정
      #- name: Add SSH key
      #  run: |
      #    mkdir -p ~/.ssh
      #    echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
      #    chmod 600 ~/.ssh/id_rsa

      # EC2 호스트 키 등록
      - name: Add EC2 Host Key
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # EC2로 배포 및 서비스 실행
      - name: Deploy to EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /path/to/your/app
            git config --global credential.helper store
            echo "https://${{ secrets.PERSONAL_ACCESS_TOKEN }}:@github.com" > ~/.git-credentials
            git pull origin main || exit 1
            source venv/bin/activate || exit 1
            pip install -r requirements.txt || exit 1
            gunicorn -w 4 -b 0.0.0.0:5000 app:app || exit 1
          EOF
